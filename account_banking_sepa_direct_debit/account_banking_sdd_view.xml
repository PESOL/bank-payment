<?xml version="1.0" encoding="utf-8"?>
<!--
  Copyright (C) 2013 Akretion (http://www.akretion.com)
  @author: Alexis de Lattre <alexis.delattre@akretion.com>
  The licence is in the file __openerp__.py
-->
<openerp>
<data>

<record id="view_banking_export_sdd_form" model="ir.ui.view">
    <field name="name">account.banking.export.sdd.form</field>
    <field name="model">banking.export.sdd</field>
    <field name="arch" type="xml">
        <form string="SEPA Direct Debit">
            <notebook>
                <page string="General Information">
                    <field name="total_amount" />
                    <field name="nb_transactions" />
                    <field name="requested_collec_date" />
                    <field name="batch_booking" />
                    <field name="charge_bearer"/>
                    <field name="create_date" />
                    <newline />
                    <field name="file" filename="filename"/>
                    <field name="filename" invisible="True"/>
                </page>
                <page string="Payment Orders">
                    <field name="payment_order_ids" colspan="4" nolabel="1">
                        <tree colors="blue:state in ('draft');gray:state in ('cancel','done');black:state in ('open')" string="Payment Orders">
                            <field name="reference"/>
                            <field name="date_created"/>
                            <field name="date_done"/>
                            <field name="total"/>
                            <field name="state"/>
                        </tree>
                    </field>
                </page>
            </notebook>
        </form>
    </field>
</record>


<record id="view_banking_export_sdd_tree" model="ir.ui.view">
    <field name="name">account.banking.export.sdd.tree</field>
    <field name="model">banking.export.sdd</field>
    <field name="arch" type="xml">
        <tree string="SEPA Direct Debit">
            <field name="filename"/>
            <field name="requested_collec_date"/>
            <field name="create_date"/>
            <field name="nb_transactions"/>
        </tree>
    </field>
</record>


<record id="action_account_banking_sdd" model="ir.actions.act_window">
    <field name="name">Generated SEPA Direct Debit Files</field>
    <field name="res_model">banking.export.sdd</field>
    <field name="view_type">form</field>
    <field name="view_mode">tree,form</field>
</record>


<menuitem id="menu_account_banking_sdd"
          parent="account_payment.menu_main_payment"
          action="action_account_banking_sdd"
          sequence="20"
          />

<act_window id="act_banking_export_sdd_payment_order"
    name="Generated SEPA Direct Debit Files"
    domain="[('payment_order_ids', '=', active_id)]"
    res_model="banking.export.sdd"
    src_model="payment.order"
    view_type="form"
    view_mode="tree,form"
/>

<record id="sdd_mandate_form" model="ir.ui.view">
    <field name="name">sdd.mandate.form</field>
    <field name="model">sdd.mandate</field>
    <field name="arch" type="xml">
        <form string="SEPA Direct Debit Mandate" version="7.0">
            <header>
                <button name="validate" type="object" string="Validate" states="draft"/>
                <button name="cancel" type="object" string="Cancel" states="draft,valid"/>
                <field name="state" widget="statusbar"/>
            </header>
            <sheet>
                <div class="oe_title">
                    <h1>
                        <field name="unique_mandate_reference" class="oe_inline"/>
                    </h1>
                </div>
                <group name="main">
                    <field name="company_id" groups="base.group_multi_company"/>
                    <field name="partner_id" invisible="not context.get('sdd_mandate_main_view')"/>
                    <field name="type"/>
                    <field name="signature_date"/>
                    <field name="scan"/>
                    <field name="last_debit_date"/>
                    <field name="partner_bank_id" invisible="not context.get('sdd_mandate_main_view')"/>
                </group>
                <group name="payment_lines" string="Related Payment Lines">
                    <field name="payment_line_ids" nolabel="1"/>
                </group>
            </sheet>
            <div class="oe_chatter">
                <field name="message_follower_ids" widget="mail_followers"/>
                <field name="message_ids" widget="mail_thread"/>
            </div>
        </form>
    </field>
</record>

<record id="sdd_mandate_tree" model="ir.ui.view">
    <field name="name">sdd.mandate.tree</field>
    <field name="model">sdd.mandate</field>
    <field name="arch" type="xml">
        <tree string="SEPA Direct Debit Mandate" colors="blue:state=='draft';black:state=='expired'">
            <field name="company_id" groups="base.group_multi_company"/>
            <field name="partner_id" invisible="not context.get('sdd_mandate_main_view')"/>
            <field name="unique_mandate_reference" string="Reference"/>
            <field name="type" string="Type"/>
            <field name="signature_date" string="Signature Date"/>
            <field name="last_debit_date"/>
            <field name="state" string="Status"/>
        </tree>
    </field>
</record>

<record id="sdd_mandate_search" model="ir.ui.view">
    <field name="name">sdd.mandate.search</field>
    <field name="model">sdd.mandate</field>
    <field name="arch" type="xml">
        <search string="Search SEPA Direct Debit Mandates">
            <field name="partner_id"/>
            <filter name="draft" string="Draft" domain="[('state', '=', 'draft')]" />
            <filter name="valid" string="Valid" domain="[('state', '=', 'valid')]" />
            <filter name="expired" string="Expired" domain="[('state', '=', 'expired')]" />
            <filter name="oneoff" string="One-Off" domain="[('type', '=', 'oneoff')]" />
            <filter name="recurrent" string="Recurrent" domain="[('type', '=', 'recurrent')]" />
        </search>
    </field>
</record>

<record id="sdd_mandate_action" model="ir.actions.act_window">
    <field name="name">SEPA Direct Debit Mandates</field>
    <field name="res_model">sdd.mandate</field>
    <field name="view_type">form</field>
    <field name="view_mode">tree,form</field>
    <field name="context">{'sdd_mandate_main_view': True}</field>
    <field name="help" type="html">
        <p class="oe_view_nocontent_create">
        Click to create a new SEPA Direct Debit Mandate.
        </p><p>
        The SEPA Direct Debit Mandate is a document signed by your customer that gives you the autorization to do one or several direct debits on his bank account.
        </p>
    </field>
</record>

<menuitem id="sdd_mandate_menu"
          parent="account_banking.menu_finance_banking_actions"
          action="sdd_mandate_action"
          sequence="20"
          />

<!-- notifications in the chatter -->
<record id="mandate_valid" model="mail.message.subtype">
    <field name="name">Mandate Validated</field>
    <field name="res_model">sdd.mandate</field>
    <field name="default" eval="False"/>
    <field name="description">SEPA Direct Debit Mandate Validated</field>
</record>

<record id="mandate_expire" model="mail.message.subtype">
    <field name="name">Mandate Expired</field>
    <field name="res_model">sdd.mandate</field>
    <field name="default" eval="False"/>
    <field name="description">SEPA Direct Debit Mandate has Expired</field>
</record>

<record id="mandate_cancel" model="mail.message.subtype">
    <field name="name">Mandate Cancelled</field>
    <field name="res_model">sdd.mandate</field>
    <field name="default" eval="False"/>
    <field name="description">SEPA Direct Debit Mandate Cancelled</field>
</record>


<record id="sdd_mandate_partner_bank_form" model="ir.ui.view">
    <field name="name">sdd.mandate.res.partner.bank.form</field>
    <field name="model">res.partner.bank</field>
    <field name="inherit_id" ref="base.view_partner_bank_form"/>
    <field name="arch" type="xml">
        <group name="bank" position="after">
            <group name="sdd_mandates" string="SEPA Direct Debit Mandates" colspan="4">
                <field name="sdd_mandate_ids" context="{'default_partner_bank_id': active_id}" nolabel="1"/>
            </group>
        </group>
    </field>
</record>

<record id="sdd_mandate_partner_bank_tree" model="ir.ui.view">
    <field name="name">sdd.mandate.res.partner.bank.tree</field>
    <field name="model">res.partner.bank</field>
    <field name="inherit_id" ref="base.view_partner_bank_tree"/>
    <field name="arch" type="xml">
        <field name="partner_id" position="after">
            <field name="sdd_mandate_ids" string="SDD Mandates"/>
        </field>
    </field>
</record>

<!-- also add number of mandates on partner form -->
<record id="sdd_mandate_partner_form" model="ir.ui.view">
    <field name="name">sdd.mandate.partner.form</field>
    <field name="model">res.partner</field>
    <field name="inherit_id" ref="account.view_partner_property_form"/>
    <field name="arch" type="xml">
        <xpath expr="//field[@name='bank_ids']/tree/field[@name='owner_name']" position="after">
            <field name="sdd_mandate_ids" string="SDD Mandates"/>
        </xpath>
    </field>
</record>

</data>
</openerp>
